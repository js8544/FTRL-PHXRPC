# Makefile
#
# Generated by phxrpc_pb2server from ftrl.proto
#
#

include /home/jinshang/Downloads/phxrpc/phxrpc.mk

LDFLAGS := -L$(PHXRPC_ROOT)/lib -lphxrpc $(LDFLAGS)

# choose to use boost for network
#LDFLAGS := $(PLUGIN_BOOST_LDFLAGS) $(LDFLAGS)

SVR_OBJS = ftrl.pb.o \
		ftrl_service_impl.o \
		phxrpc_ftrl_service.o \
		phxrpc_ftrl_dispatcher.o \
		ftrl_server_config.o \
		ftrl_main.o

CLI_OBJS = ftrl.pb.o \
		ftrl_client.o \
		phxrpc_ftrl_stub.o

TARGETS = libftrl_client.a ftrl_main ftrl_tool_main ftrl

all: $(TARGETS)

ftrl_main: $(SVR_OBJS)
	$(LINKER) $^ $(LDFLAGS) -o $@

libftrl_client.a: $(CLI_OBJS)
	$(AR) $@ $^

ftrl_tool_main: phxrpc_ftrl_tool.o ftrl_tool_impl.o ftrl_tool_main.o
	$(LINKER) $^ -L. -lftrl_client $(LDFLAGS) -o $@

ftrl: ./include/FTRL.cpp ./include/sparse_vector.cpp ./include/corpus.cpp
	g++ -std=c++11 ./include/FTRL.cpp ./include/sparse_vector.cpp ./include/corpus.cpp -o ftrl -fopenmp

########## message ##########

ftrl.pb.cc: ftrl.pb.h

ftrl.pb.h: ftrl.proto
	$(PROTOBUF_ROOT)/bin/protoc -I$(PROTOBUF_ROOT)/include --cpp_out=. -I$(PHXRPC_ROOT) -I. $^

########## client ##########

phxrpc_ftrl_stub.cpp: phxrpc_ftrl_stub.h
phxrpc_ftrl_stub.o: phxrpc_ftrl_stub.h
ftrl_client.cpp: phxrpc_ftrl_stub.h
ftrl_client.o: phxrpc_ftrl_stub.h

phxrpc_ftrl_stub.h: ftrl.proto
	$(PHXRPC_ROOT)/codegen/phxrpc_pb2client $(PBFLAGS) -f $^ -d .

########## service ##########

phxrpc_ftrl_service.cpp: phxrpc_ftrl_service.h
phxrpc_ftrl_service.o: phxrpc_ftrl_service.h
ftrl_service_impl.cpp: phxrpc_ftrl_service.h
ftrl_service_impl.o: phxrpc_ftrl_service.h
phxrpc_ftrl_dispatcher.cpp: phxrpc_ftrl_service.h
phxrpc_ftrl_dispatcher.o: phxrpc_ftrl_service.h

phxrpc_ftrl_service.h: ftrl.proto
	$(PHXRPC_ROOT)/codegen/phxrpc_pb2service $(PBFLAGS) -f $^ -d .

########## tool ##########

phxrpc_ftrl_tool.cpp: phxrpc_ftrl_tool.h
phxrpc_ftrl_tool.o: phxrpc_ftrl_tool.h
ftrl_tool_impl.cpp: phxrpc_ftrl_tool.h
ftrl_tool_impl.o: phxrpc_ftrl_tool.h
ftrl_tool_main.cpp: phxrpc_ftrl_tool.h
ftrl_tool_main.o: phxrpc_ftrl_tool.h

phxrpc_ftrl_tool.h: ftrl.proto
	$(PHXRPC_ROOT)/codegen/phxrpc_pb2tool $(PBFLAGS) -f $^ -d .

clean:
	@($(RM) $(TARGETS))
	@($(RM) *.o)
	@($(RM) phxrpc_*)
	@($(RM) *.pb.*)

